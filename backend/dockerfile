# Production Dockerfile for Go-CRM Django Backend
FROM python:3.13

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    DJANGO_SETTINGS_MODULE=core.settings.prod \
    PYTHONPATH=/app

# Accept build arguments for environment variables
ARG SECRET_KEY
ARG DEBUG
ARG ALLOWED_HOSTS
ARG POSTGRES_NAME
ARG POSTGRES_USER
ARG POSTGRES_PASSWORD
ARG POSTGRES_HOST
ARG POSTGRES_PORT
ARG CORS_ALLOWED_ORIGINS
ARG CSRF_TRUSTED_ORIGINS
ARG AZURE_ACCOUNT_NAME
ARG AZURE_KEY
ARG AZURE_CONTAINER
ARG AZURE_CONNECTION_STRING
ARG AZURE_STATIC_URL

# Set them as environment variables
ENV SECRET_KEY=$SECRET_KEY
ENV DEBUG=$DEBUG
ENV ALLOWED_HOSTS=$ALLOWED_HOSTS
ENV POSTGRES_NAME=$POSTGRES_NAME
ENV POSTGRES_USER=$POSTGRES_USER
ENV POSTGRES_PASSWORD=$POSTGRES_PASSWORD
ENV POSTGRES_HOST=$POSTGRES_HOST
ENV POSTGRES_PORT=$POSTGRES_PORT
ENV CORS_ALLOWED_ORIGINS=$CORS_ALLOWED_ORIGINS
ENV CSRF_TRUSTED_ORIGINS=$CSRF_TRUSTED_ORIGINS
ENV AZURE_ACCOUNT_NAME=$AZURE_ACCOUNT_NAME
ENV AZURE_KEY=$AZURE_KEY
ENV AZURE_CONTAINER=$AZURE_CONTAINER
ENV AZURE_CONNECTION_STRING=$AZURE_CONNECTION_STRING
ENV AZURE_STATIC_URL=$AZURE_STATIC_URL

COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

RUN apt-get update \
  && apt-get install -y build-essential libpq-dev gettext curl \
  && apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false \
  && rm -rf /var/lib/apt/lists/*

RUN addgroup --system django && adduser --system --ingroup django django

RUN uv venv /opt/venv

ENV PATH="/opt/venv/bin:$PATH"

# Copy requirements.txt from backend directory (build context is project root)
COPY backend/requirements.txt /tmp/requirements.txt

# Install Python dependencies
RUN uv pip install -r /tmp/requirements.txt && rm /tmp/requirements.txt

# Create necessary directories
RUN mkdir -p /app/logs /app/staticfiles /app/mediafiles

# Copy backend directory to /app
COPY --chown=django:django backend/ /app

# Change working directory to /app where manage.py is located
WORKDIR /app

# Make entrypoint executable
RUN chmod +x /app/entrypoint.sh

HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
  CMD curl -f http://localhost:8000/health/ || exit 1

USER django

EXPOSE 8000

# Run entrypoint script (collectstatic + daphne)
CMD ["/app/entrypoint.sh"]